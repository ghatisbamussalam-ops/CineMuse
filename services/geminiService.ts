import { GoogleGenAI } from "@google/genai";
import { AnalysisPreferences } from '../types';

const API_KEY = process.env.API_KEY;

function buildPrompt(preferences: AnalysisPreferences): string {
  const {
    workName,
    workType,
    analysisAngles,
    depth,
    technicality,
    writingStyle,
    geoContext,
    hideSpoilers,
    includeQuotes,
    appendices,
  } = preferences;

  const depthMap = {
      'مختصر': 'حوالي 150-250 كلمة',
      'متوسط': 'حوالي 400-700 كلمة',
      'متعمق': 'حوالي 900-1300 كلمة',
  };

  return `
أنت ناقد سينمائي وموسيقي وخبير ثقافي مرموق. مهمتك هي تقديم تحليل عميق باللغة العربية الفصيحة للعمل التالي: "${workName}".

يجب أن تلتزم التزامًا صارمًا بالتفضيلات التالية التي حددها المستخدم:

- **نوع العمل**: ${workType}. (إذا كان الخيار "تلقائي"، حدد النوع بنفسك بناءً على الاسم. إذا لم تكن متأكدًا، افترض النوع الأكثر احتمالاً وقدم تحليلك بناءً عليه دون طرح أسئلة).
- **زوايا التحليل المختارة**: ${analysisAngles.join('، ')}. ركز تحليلك على هذه الزوايا بشكل أساسي.
- **عمق التحليل**: ${depth} (${depthMap[depth]}).
- **الدرجة التقنية**: ${technicality}.
- **الأسلوب الكتابي**: ${writingStyle}.
- **السياق الجغرافي/الثقافي**: ${geoContext}. (أعطِ هذا السياق أهمية خاصة في تحليلك إن كان "عربي" أو "يمني").
- **إخفاء حرق الأحداث (Spoilers)**: ${hideSpoilers ? 'مفعّل. تجنب تمامًا كشف أي نقاط حاسمة في الحبكة، أو ضع تحذيرًا واضحًا جدًا قبل أي فقرة قد تحتوي على حرق.' : 'غير مفعّل.'}
- **إدراج اقتباسات**: ${includeQuotes ? 'مفعّل. أدرج اقتباسات قصيرة (لا تزيد عن 20 كلمة) من الحوارات أو الكلمات إن توفرت وكانت ذات صلة.' : 'غير مفعّل.'}
- **ملاحق إضافية مطلوبة**: ${appendices.length > 0 ? appendices.join('، ') : 'لا يوجد'}.

**هيكل الإخراج المطلوب:**

إذا كان العمل **فيلمًا**، استخدم الهيكل التالي بعناوين واضحة:
1.  **ملخص الفيلم وسياقه التاريخي**
2.  **تحليل الرموز البصرية والسردية الأساسية**
3.  **تفسير فلسفي للثيمات** (بناءً على الزوايا المختارة)
4.  **قراءة نقدية للأبعاد الاجتماعية والنفسية** (بناءً على الزوايا المختارة)
5.  **مناقشة الأسلوب الفني**
6.  **الربط بالسياق الثقافي والحياة اليومية** (خاصة إذا اختير سياق غير "عالمي")
7.  **أثر الفيلم على السينما والجمهور**
8.  **ملاحق** (إذا طُلبت)

إذا كان العمل **أغنية**، استخدم الهيكل التالي بعناوين واضحة:
1.  **سياق الأغنية وخلفيتها الفنية**
2.  **تحليل الكلمات والرموز الشعرية** (مع مراعاة مستوى التقنية)
3.  **التأويل النفسي والاجتماعي للنص الغنائي** (بناءً على الزوايا المختارة)
4.  **دلالات اللحن والصوت والأداء والتوزيع**
5.  **التأثير الثقافي والوجدان الجمعي**
6.  **ملاحق** (إذا طُلبت)

**متطلبات الجودة والأسلوب:**
-   **اللغة**: استخدم لغة عربية فصيحة، أنيقة، وسلسة.
-   **المنهجية**: ميّز بوضوح بين **الحقائق الموضوعية** و**التأويلات النقدية** (استخدم عبارات مثل "من منظور سيميائي..." أو "يمكن تأويل هذا المشهد على أنه...").
-   **عدم اليقين**: إذا كانت المعلومات غير متوفرة أو غير مؤكدة، صرّح بذلك.
-   **الناتج**: يجب أن يكون الناتج بالكامل بصيغة Markdown، باستخدام ## للعناوين الرئيسية و ### للعناوين الفرعية.

في النهاية، أضف قسمًا أخيرًا بعنوان **"## الإعدادات المُطبّقة"** ولخّص فيه بوضوح كل التفضيلات التي اتبعتها في هذا التحليل.
`;
}

export const generateAnalysis = async (preferences: AnalysisPreferences): Promise<string> => {
    if (!API_KEY) {
        throw new Error("API key not found. Please set the API_KEY environment variable.");
    }
    
    if (!preferences.workName.trim()) {
        throw new Error("Work name cannot be empty.");
    }

    const ai = new GoogleGenAI({ apiKey: API_KEY });
    
    const prompt = buildPrompt(preferences);

    try {
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: prompt,
        });

        return response.text;
    } catch (error) {
        console.error("Error calling Gemini API:", error);
        throw new Error("Failed to get analysis from the service. The model may have blocked the request.");
    }
};